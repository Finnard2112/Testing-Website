<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/icomoonStyle.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/coreMain.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/dayGridmain.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/calendarStyle.css') }}">
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.1/css/all.min.css'>
  <link rel='stylesheet'
    href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css'>
  <link rel="stylesheet" href="{{ url_for('static', filename='CSS/style.css') }}">
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <link rel = 'stylesheet' href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <style type="text/css">
    .pink-background {
      background-color: #f67280;
    }

    .blue-background {
      background-color: #0051E9;
    }

    .white {
      color: #ffffff;
    }

    .header {
      padding: 20px;
      text-align: left;
      background: #0051E9;
      color: white;
      font-size: 30px;
    }

    .no-click {
      pointer-events: none;
    }
    .logout-btn {
      border-radius: 0;
      border: 1px outset rgb(255, 255, 255);
    }

    .username-btn {
      border-radius: 0;
    }
  </style>
  <title>Hệ Thống Test Tải</title>
  <script>
    $(document).ready(function(){
      toastr.options = {
            "tapToDismiss": true,
            "closeButton": true,
            "debug": false,
            "positionClass": "toast-bottom-right",
            "onclick": null,
            "showDuration": "1000",
            "hideDuration": "1000",
            "timeOut": "300000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut", 
            "preventDuplicates" : true}
      
      {% for message in get_flashed_messages() %}

      toastr.error('{{ message }}');

      {% endfor %}
      

    });
    </script>
</head>

<body>
  <div class="container-fluid">
    <div class="header">
      <button style="float: right;" type="button" onclick="logout()" class='btn logout-btn pink-background white float-right'> Đăng
        Xuất
      </button>
      <div style="float: right;" class='btn username-btn pink-background white float-right no-click'> {{username}} </div>
      <h1> Hệ Thống Test Tải</h1>
    </div>
  </div>
  <div class="container-fluid">
    <div class="content">
      <div id='calendar'></div>
    </div>
    {% if is_in_registered_time %}
    <button type="button" onclick="load_test_form()" class="btn btn-lg btn-block blue-background white"> Đi tới form
      đăng ký test
      tải</button>
    {% endif %}
    <form method="post">
      <div class="content">
        <div class="row">
          <div class="col-sm">

            <h5>Thới gian bắt đầu</h5>
            <div class="form-group">
              <label>Ngày</label>
              <div class="input-group date" id="datepicker">
                <input class="form-control" placeholder="MM/DD/YYYY" name="start_date" required />
                <span class="input-group-append input-group-addon"><span class="input-group-text"><i
                      class="fa fa-calendar"></i></span></span>
              </div>
            </div>
            <div class="form-group">
              <label>Giờ và phút</label>
              <div class="input-group time" id="timepicker">
                <input class="form-control" placeholder="HH:MM AM/PM" name="start_time" required />
                <span class="input-group-append input-group-addon"><span class="input-group-text"><i
                      class="fa fa-clock"></i></span></span>
              </div>
            </div>

          </div>
          <div class="col-sm">

            <h5>Thời gian kết thúc</h5>
            <div class="form-group">
              <label>Ngày</label>
              <div class="input-group date" id="datepicker2">
                <input class="form-control" placeholder="MM/DD/YYYY" name="end_date" required />
                <span class="input-group-append input-group-addon"><span class="input-group-text"><i
                      class="fa fa-calendar"></i></span></span>
              </div>
            </div>
            <div class="form-group">
              <label>Giờ và Phút</label>
              <div class="input-group time" id="timepicker2">
                <input class="form-control" placeholder="HH:MM AM/PM" name="end_time" required />
                <span class="input-group-append input-group-addon"><span class="input-group-text"><i
                      class="fa fa-clock"></i></span></span>
              </div>
            </div>

          </div>
        </div>
        <div class="pt-1 mb-4">
          <button class="btn btn-lg btn-block blue-background white" type="submit" name="submitbtn">Gửi</button>
        </div>
      </div>
    </form>
  </div>
  <script src="{{ url_for('static', filename='JS/coreMain.js') }}"></script>
  <script src="{{ url_for('static', filename='JS/interactionMain.js') }}"></script>
  <script src="{{ url_for('static', filename='JS/daygridMain.js') }}"></script>
  <script>
    let current = new Date();
    const month = String(current.getMonth() + 1).padStart(2, '0');
    const day = String(current.getDate()).padStart(2, '0');
    let cDate = current.getFullYear() + '-' + month + '-' + day;
    var clickedDelete = false;
    document.addEventListener('DOMContentLoaded', function () {
      var calendarEl = document.getElementById('calendar');
      let current = new Date();
      var calendar = new FullCalendar.Calendar(calendarEl, {
        timeZone: 'local',
        plugins: ['interaction', 'dayGrid'],
        defaultDate: cDate,
        eventLimit: true, // allow "more" link when too many events
        height: "70%",
        events: {{events | safe}},
        eventClick: function (info) {
          if (clickedDelete == true) {
            clickedDelete = false;
          } else {
            var eventObj = info.event;
            alert("Testing starts: " + eventObj.start + "; Testing ends: " + eventObj.end);
            info.jsEvent.preventDefault(); // don't let the browser navigate
          }

        },
        eventOverlap: function (stillEvent, movingEvent) {
          return false;
        },
        eventDrop: function (info) {
          alert("Session của " + info.event.title + " đã được chuyển đến " + info.event.start.toString());
          if (!confirm("Bạn có muốn thay đổi?")) {
            info.revert();
          } else {
            var url = "/autotest_registration";
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
              title: info.event.title,
              start: info.event.start.toString(),
              oldstart: info.oldEvent.start.toString(),
              end: info.event.end.toString(),
            }));
          }
        },
        eventRender: function (info) {
          if ("{{username}}" == info.event.title || "{{role}}" == "admin") {
            $(info.el).prepend(
              "<span style=\"color:#fff;font-weight:bold; text-shadow: 2px 2px 4px #000000;\" class='removebtn'>&#10006</span>"
            );
          }
          $(info.el).find(".removebtn").click(function () {
            if (confirm("Bạn có muốn xóa?")) {
              clickedDelete = true;
              var url = "/autotest_registration";
              var xhr = new XMLHttpRequest();
              xhr.open("DELETE", url, true);
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.send(JSON.stringify({
                id: info.event.id,
                username: info.event.title
              }));
              xhr.onload = function () {
                const response = JSON.parse(this.responseText);
                if (response.delete == 1) {
                  alert("Successful")
                  info.event.remove();
                } else {
                  alert("Unable to Delete")
                }
              }
            } else {
              clickedDelete = true;
            }
          });
        }
      });

      calendar.setOption('height', 600);
      // calendar.addEvent();

      calendar.render();
    });

    function load_test_form() {
      location.replace("{{url_for('loadtest_form')}}")
    }

    function logout() {
      location.replace("{{url_for('logout')}}")
    }
  </script>
  
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js'></script>
  <script
    src='https://cdnjs.cloudflare.com/ajax/libs/eonasdan-bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js'>
  </script>
  <script src="{{ url_for('static', filename='JS/script.js') }}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</body>

</html>